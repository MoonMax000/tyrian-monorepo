# Порядок запросов для изменения email пользователя

## Обзор процесса

Процесс изменения email состоит из трех этапов с двумя подтверждениями для обеспечения безопасности.

## Этапы процесса

### 1. Запрос на изменение email
**Эндпойнт:** `POST /profile/email-change/verification/`

Пользователь указывает текущий и новый email адреса.

**Запрос:**
```json
{
    "current_email": "user@example.com",
    "new_email": "newuser@example.com"
}
```

**Ответ:**
```json
{
    "detail": "Email change verification sent",
    "token": "encrypted_token_here"
}
```

**Проверки:**
- Пользователь аутентифицирован и активен
- `current_email` соответствует email текущего пользователя
- `new_email` имеет корректный формат

**Действия бэкенда:**
- Сохраняет новый email в кэше (`change_{current_email}`)
- Создает зашифрованный токен с информацией о пользователе и новом email
- возвращает токен фронтенду

### 2. Подтверждение смены email
**Эндпойнт:** `POST /profile/email-change/confirm/`

Пользователь переходит по ссылке из письма и вводит код верификации.

**Запрос:**
```json
{
    "token": "encrypted_token_from_email",
    "code": "123456"
}
```

**Ответ:**
```json
{
    "detail": "Запрос успешно подтвержден, отправлен код верификации на новую почту"
}
```

**Проверки:**
- Токен валиден и не истек
- Код верификации соответствует сохраненному в кэше
- Кэшированный новый email соответствует email из токена

**Действия бэкенда:**
- Расшифровывает токен и извлекает информацию о пользователе и новом email
- Проверяет код верификации из кэша (`change_email_verify_code_{new_email}`)
- Удаляет код верификации из кэша
- Отправляет код верификации на новый email адрес

### 3. Финальное изменение email
**Эндпойнт:** `POST /profile/email-change/`

Пользователь вводит код, полученный на новый email адрес.

**Запрос:**
```json
{
    "code": "123456"
}
```

**Ответ:**
```json
{
    "detail": "Email changed successfully"
}
```

**Проверки:**
- Пользователь аутентифицирован и активен
- В кэше сохранен новый email (`change_{user.email}`)
- Код верификации соответствует сохраненному (`verify_code_{cached_email}`)

**Действия бэкенда:**
- Проверяет код верификации для кэшированного email
- Деактивирует все текущие сессии пользователя
- Изменяет email пользователя на кэшированный
- Очищает кэш от всех связанных данных

## Безопасность

- **Двойное подтверждение:** Требуется подтверждение как со старого, так и с нового email
- **Шифрование токенов:** Информация о пользователе и новом email зашифрована в токене
- **Кэширование:** Новый email сохраняется в кэше и не передается в открытом виде
- **Проверка соответствия:** На каждом этапе проверяется соответствие данных
- **Деактивация сессий:** После смены email все текущие сессии пользователя деактивируются

## Коды ответов

- **200** - Успешное выполнение операции
- **400** - Неверные данные запроса или истекший код
- **401** - Пользователь не аутентифицирован
- **403** - Пользователь неактивен или удален
- **404** - Пользователь не найден