# Тесты для модуля профиля пользователя

Этот каталог содержит тесты для функциональности обновления профиля пользователя, включая верификацию критических полей и обычное обновление профиля.

## Структура тестов

### 1. `test_profile_verification.py`
Тесты для представлений верификации критических полей профиля:

- **ProfileVerificationRequestViewTest**: Тестирует запрос верификации
  - Успешный запрос для одного поля
  - Успешный запрос для нескольких полей
  - Обработка несуществующих пользователей
  - Валидация входных данных
  - Поддержка SMS и email методов верификации

- **ProfileVerificationConfirmViewTest**: Тестирует подтверждение верификации
  - Изменение одного поля
  - Изменение нескольких полей одновременно
  - Изменение пароля
  - Обработка неверных токенов
  - Обработка истекших кодов
  - Частичное обновление полей

### 2. `test_profile_update.py`
Тесты для представления обновления обычных полей профиля:

- **ProfileUpdateViewTest**: Тестирует обновление профиля
  - Полное обновление (PUT)
  - Частичное обновление (PATCH)
  - Требование аутентификации
  - Валидация формата username
  - Проверка уникальности username
  - Валидация URL и сектора
  - Загрузка изображений (avatar, background_image)
  - Очистка необязательных полей
  - Изменение роли и сектора
  - Обновление резервной контактной информации
  - Обработка ошибок валидации

### 3. `test_profile_serializers.py`
Тесты для сериализаторов профиля:

- **ProfileVerificationRequestSerializerTest**: Тестирует сериализатор запроса верификации
  - Валидация email
  - Валидация списка полей для изменения
  - Проверка всех допустимых значений полей

- **ProfileVerificationConfirmSerializerTest**: Тестирует сериализатор подтверждения верификации
  - Валидация токена
  - Валидация новых значений

- **ProfileUpdateSerializerTest**: Тестирует сериализатор обновления профиля
  - Валидация формата username
  - Проверка уникальности username
  - Валидация выбора сектора и метода верификации
  - Проверка длины полей
  - Частичное обновление

### 4. `test_profile_models.py`
Тесты для моделей профиля:

- **UserRoleModelTest**: Тестирует модель роли пользователя
  - Создание ролей
  - Уникальность имени
  - Сортировка
  - Meta класс

- **UserModelTest**: Тестирует модель пользователя
  - Создание пользователей
  - Валидация username
  - Уникальность username
  - Выбор сектора и метода верификации
  - Значения по умолчанию
  - Методы __str__ и Meta
  - Сортировка
  - Необязательные поля
  - Валидация длины полей

### 5. `test_profile_admin.py`
Тесты для админки профиля:

- **UserRoleAdminTest**: Тестирует админку ролей пользователей
  - Отображение списка
  - Поля поиска
  - Сортировка
  - Структура полей
  - Доступ к админке

- **UserAdminTest**: Тестирует админку пользователей
  - Отображение списка
  - Поля поиска и фильтры
  - Только для чтения поля
  - Структура полей
  - Методы админки

### 6. `test_profile_urls.py`
Тесты для URL маршрутов профиля:

- **ProfileURLsTest**: Тестирует URL маршруты
  - Правильность путей
  - Разрешение в представления
  - Структура URL
  - HTTP методы
  - Пространство имен
  - Согласованность

### 7. `test_profile_integration.py`
Интеграционные тесты для профиля:

- **ProfileIntegrationTest**: Тестирует полный цикл обновления
  - Полный цикл обновления профиля
  - Обновление с ролью и сектором
  - Изменение метода верификации
  - Частичное vs полное обновление
  - Обновление нескольких критических полей
  - Интеграция валидации
  - Обработка ошибок
  - Требования аутентификации

## Запуск тестов

### Запуск всех тестов профиля:
```bash
python manage.py test accounts.views.tests.test_profile_verification
python manage.py test accounts.views.tests.test_profile_update
python manage.py test accounts.views.tests.test_profile_serializers
python manage.py test accounts.views.tests.test_profile_models
python manage.py test accounts.views.tests.test_profile_admin
python manage.py test accounts.views.tests.test_profile_urls
python manage.py test accounts.views.tests.test_profile_integration
```

### Запуск конкретного теста:
```bash
python manage.py test accounts.views.tests.test_profile_verification.ProfileVerificationRequestViewTest.test_successful_verification_request_single_field
```

### Запуск с подробным выводом:
```bash
python manage.py test accounts.views.tests.test_profile_verification --verbosity=2
```

## Особенности тестирования

### Мокирование внешних зависимостей
- **Email отправка**: Используется `@patch('accounts.views.profile_verification.send_mail')`
- **SMS отправка**: Логируется (реализация в разработке)

### Кэш
- Кэш очищается перед каждым тестом в `setUp()` и `tearDown()`
- Коды верификации сохраняются в кэш для тестирования

### База данных
- Каждый тест создает свои тестовые данные
- Используется транзакционная база данных для тестов

### Аутентификация
- Для тестов обновления профиля используется `force_authenticate`
- Тестируется требование аутентификации

## Покрытие тестами

Тесты покрывают:
- ✅ Все представления профиля
- ✅ Все сериализаторы профиля
- ✅ Все модели профиля
- ✅ Админку профиля
- ✅ URL маршруты профиля
- ✅ Интеграционные сценарии
- ✅ Обработку ошибок
- ✅ Валидацию данных
- ✅ Бизнес-логику

## Добавление новых тестов

При добавлении новой функциональности в профиль:

1. Создайте соответствующий тест в существующем файле или создайте новый
2. Следуйте существующему стилю именования и структуре
3. Добавьте тесты для позитивных и негативных сценариев
4. Обновите этот README файл
5. Убедитесь, что все тесты проходят

## Требования

- Django 4.0+
- Django REST Framework 3.12+
- Pillow (для ImageField)
- pytest (опционально, для расширенного тестирования)
