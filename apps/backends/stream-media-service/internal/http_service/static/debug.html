<html>
  <meta charset="UTF-8">
  <head>
    <title>Отладка медиасервиса</title>
  </head>

  <body>
    <form style="border-width: 1px; border-color: aqua" action="javascript:void(0);">
      <button onclick="window.doWHIP()">Публикация</button>
      &nbsp;Stream key:<input type="text" id="streamKey" name="streamKey" value="AQMip3B5Rpn66ajW1WgwSw"/><br />
      <input type="checkbox" id="enableVideo" name="enableVideo" />
      <label for="enableVideo">(Публикация) разрешить транслировать видео</label><br />

      <input type="checkbox" id="enableAudio" name="enableAudio" checked />
      <label for="enableAudio">(Публикация) разрешить транслировать аудио</label><br />
    </form>

    <form style="border-width: 1px; border-color: aqua" action="javascript:void(0);">
      Link suffix:<input type="text" id="translationLinkSuffix" name="translationLinkSuffix" value="0"/><br />
      <button onclick="window.doWHEP()">Подключиться к трансляции (/video/*)</button>
    </form>

    <h3>Просмотр аудио/видео потоков</h3>
    <video id="videoPlayer" autoplay controls style="width: 500"></video>

    <h3>Статусы подключния к ICE серверу</h3>
    <div id="iceConnectionStates"></div>
    <br />
  </body>

  <script>
    let peerConnection = new RTCPeerConnection();

    peerConnection.oniceconnectionstatechange = () => {
      let el = document.createElement("p");
      el.appendChild(
        document.createTextNode(peerConnection.iceConnectionState)
      );

      document.getElementById("iceConnectionStates").appendChild(el);
    };

    window.doWHEP = () => {
      const translationLinkSuffix = document.getElementById("translationLinkSuffix").value;

      peerConnection.addTransceiver("video", { direction: "recvonly" });
      peerConnection.addTransceiver("audio", { direction: "recvonly" });

      peerConnection.ontrack = function (event) {
        document.getElementById("videoPlayer").srcObject = event.streams[0];
      };

      peerConnection.createOffer().then((offer) => {
        peerConnection.setLocalDescription(offer);
        console.log('offer: ' + offer.sdp)

        fetch(`/video/${translationLinkSuffix}`, {
          method: "POST",
          body: offer.sdp,
          headers: {
            Authorization: `Bearer none`,
            "Content-Type": "application/sdp",
          },
        })
          .then((r) => r.text())
          .then((answer) => {
            console.log('=================')
            console.log('answer: ' + answer)

            peerConnection.setRemoteDescription({
              sdp: answer,
              type: "answer",
            });
          });
      });
    };

    window.doWHIP = () => {
      const enableVideo = document.getElementById("enableVideo").checked;
      const enableAudio = document.getElementById("enableAudio").checked;
      const streamKey = document.getElementById("streamKey").value;

      navigator.mediaDevices
        .getUserMedia({ video: enableVideo, audio: enableAudio })
        .then((stream) => {
          document.getElementById("videoPlayer").srcObject = stream;
          stream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, stream));

          peerConnection.createOffer().then((offer) => {
            peerConnection.setLocalDescription(offer);

            fetch(`/whip`, {
              method: "POST",
              body: offer.sdp,
              headers: {
                Authorization: `Bearer ${streamKey}`,
                "Content-Type": "application/sdp",
              },
            })
              .then((r) => r.text())
              .then((answer) => {
                peerConnection.setRemoteDescription({
                  sdp: answer,
                  type: "answer",
                });
              });
          });
        });
    };
  </script>
</html>
